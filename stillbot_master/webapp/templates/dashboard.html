<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <title>Stillbot</title>
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">

        <script type="text/javascript" src="{{ STATIC_URL }}d3.min.js"></script>
        <script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>

        <style>
                /* tell the SVG path to be a thin blue line without any area fill */
                path {
                        stroke: steelblue;
                        stroke-width: 1;
                        fill: none;
                }
                
                .axis {
                  shape-rendering: crispEdges;
                }

                .x.axis line {
                  stroke: lightgrey;
                }

                .x.axis .minor {
                  stroke-opacity: .5;
                }

                .x.axis path {
                  display: none;
                }

                .y.axis line, .y.axis path {
                  fill: none;
                  stroke: #000;
                }
        </style>
    </head>

    <body>

        <!--[if lt IE 8]>
            <p class="browsehappy">You are using an <strong>outdated</strong> browser. Please <a href="http://browsehappy.com/">upgrade your browser</a> to improve your experience.</p>
        <![endif]-->
        <div id="graph" class="aGraph" style="position:absolute;top:0px;left:0; float:left;"></div>
        <script>

        /* implementation heavily influenced by http://bl.ocks.org/1166403 */
        var drawGraph = function(data) {
            var pyDateFormatter = function(pythonDate) {
                return pythonDate.substring(0, pythonDate.length - 5);
            }
                    
            // define dimensions of graph
            var margin = {top: 80, right: 80, bottom: 80, left: 80};
            var w = 960 - margin.left - margin.right;
            var h = 500 - margin.top - margin.bottom;
            
            // create a simple data array that we'll plot with a line (this array represents only the Y values, X will just be the index location)
            //var data = [3, 6, 2, 7, 5, 2, 0, 3, 8, 9, 2, 5, 9, 3, 6, 3, 6, 2, 7, 5, 2, 1, 3, 8, 9, 2, 5, 9, 2, 7];
            var format = d3.time.format("%Y-%m-%dT%X")
            var tempFn = function(d) { return d.temp }
            var dateFn = function(d) { return format.parse(pyDateFormatter(d.created_on)) }

            // X scale will fit all values from data[] within pixels 0-w
            //var x = d3.scale.linear().domain([0, data.length]).range([0, w]);
            var PAD_DATE = 30;
            var MIN_DATE = 0;
            var MAX_DATE = 250;
            var x = d3.time.scale()
              .domain(d3.extent(data, dateFn))
              .range([MIN_DATE, MAX_DATE + PAD_DATE])

            // Y scale will fit values from 0-10 within pixels h-0 (Note the inverted domain for the y-scale: bigger is up!)
            //var y = d3.scale.linear().domain([0, 10]).range([h, 0]);
            var PAD_TEMP = 25;
            var MIN_TEMP = 10;
            var MAX_TEMP = 125;
            var y = d3.scale.linear()
              .domain(d3.extent(data, tempFn))            // extent() automatically finds the min/max
              .range([MAX_TEMP + PAD_TEMP, MIN_TEMP])     // Our range of representation

            // create a line function that can convert data[] into x and y points
            var line = d3.svg.line()
                    // assign the X function to plot our line as we wish
                    .x(function(d,i) { 
                            var new_x = dateFn(d);
                            // verbose logging to show what's actually being done
                            console.log('Plotting X value for data point: ' + d + ' using index: ' + i + ' to be at: ' + new_x + ' using our xScale.');
                            // return the X coordinate where we want to plot this datapoint
                            return x(new_x); 
                    })
                    .y(function(d) { 
                            var new_y = tempFn(d);
                            // verbose logging to show what's actually being done
                            console.log('Plotting Y value for data point: ' + d + ' to be at: ' + new_y + " using our yScale.");
                            // return the Y coordinate where we want to plot this datapoint
                            return y(new_y); 
                    })

                    // Add an SVG element with the desired dimensions and margin.
                    var graph = d3.select("#graph").append("svg:svg")
                          .attr("width", w + margin.right + margin.left)
                          .attr("height", h + margin.top + margin.bottom)
                        .append("svg:g")
                          .attr("transform", "translate(" + margin.right + "," + margin.top + ")");

                    
                    /*
                    var xAxis = d3.svg.axis().scale(x).tickSize(-h).tickSubdivide(true);    // create yAxis
                    graph.append("svg:g")           // Add the x-axis.
                          .attr("class", "x axis")
                          .attr("transform", "translate(0," + h + ")")
                          .call(xAxis);
                    */

                    
                    var yAxisLeft = d3.svg.axis().scale(y).ticks(4).orient("left");     // create left yAxis
                    graph.append("svg:g")           // Add the y-axis to the left
                          .attr("class", "y axis")
                          .attr("transform", "translate(-25,0)")
                          .call(yAxisLeft);
                    
                    // Add the line by appending an svg:path element with the data line we created above
                    // do this AFTER the axes above so that the line is above the tick-lines
                    graph.append("svg:path").attr("d", line(data));
            }

            d3.json('http://localhost:8000/api/v1/temperatures/?page_size=50?thermistor__index=1', function(error, json) {
                if (error) return console.warn(error);
                drawGraph(json.results);
            });
        </script>
    </body>
